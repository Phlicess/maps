<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'/>
  <title>Maps</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>

  <!--script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.15.0/mapbox-gl.js'></script-->
  <script src="./mapbox-gl_patched_issue2236.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/8.3.0/nouislider.min.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.1.min.js"
          integrity="sha256-gvQgAFzTH6trSrAWoH1iPo9Xc96QxSZ3feW6kem+O00=" crossorigin="anonymous"></script>

  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.15.0/mapbox-gl.css' rel='stylesheet'/>
  <link href='nouislider.css' rel='stylesheet'/>
  <link href='style.css' rel='stylesheet'/>

</head>
<body>
  <div id='map' class="map"></div>

  <div class='features features-about'>
    <div class="logo"></div>
    <h3>GBIF Maps v2</h3>
    <h4>For demonstration purposes only</h4>
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZ2JpZiIsImEiOiJjaW0xeXU1c3gwMG04dm1tNXB3cjJ3Zm12In0.8A2pUP_lgL19w4G5L0fDNw';

    var minYear = 1900;
    var maxYear = 2016;
    var occurrenceLayer = "http://api.gbif.org/v1/map/density/tile?x={x}&y={y}&z={z}&palette=reds&resolution=1";

    /**
     * Initialises the map, taking the year slider into consideration.
     */
    function initMap(map, minYear, maxYear) {
      // Remove layers if they exist
      if (map.getSource('tile')) map.removeSource('tile');
      if (map.getLayer('tile')) map.removeLayer('tile');
      if (map.getSource('points')) map.removeSource('points');
      if (map.getLayer('points')) map.removeLayer('points');

      map.addSource('tile', {
        type: 'vector',
        //"tiles": ["http://localhost:7001/api/solr/{z}/{x}/{y}.pbf?taxon_key=5231190"]
        "tiles": ["http://localhost:7001/api/solr/{z}/{x}/{y}.pbf?taxon_key=212"]        
      });

      map.addLayer({
        "id": "demo",
        "type": "line",
        "source": "tile",
        "source-layer": "OBSERVATION",
        "paint": {
          "line-color": "#666666",
          "line-width": 0.5
        }
      });
      map.addLayer({
        "id": "p1",
        "type": "fill",
        "source": "tile",
        "source-layer": "OBSERVATION",
        "paint": {
          "fill-color": "#FFFF00"
        },
        "filter": [">", "count", 0]
      });      
      
      map.addLayer({
        "id": "p10",
        "type": "fill",
        "source": "tile",
        "source-layer": "OBSERVATION",
        "paint": {
          "fill-color": "#FFCC00"
        },
        "filter": [">", "count", 10]
      });
      map.addLayer({
        "id": "p100",
        "type": "fill",
        "source": "tile",
        "source-layer": "OBSERVATION",
        "paint": {
          "fill-color": "#FF9900"
        },
        "filter": [">", "count", 100]
      });
      map.addLayer({
        "id": "p1000",
        "type": "fill",
        "source": "tile",
        "source-layer": "OBSERVATION",
        "paint": {
          "fill-color": "#FF6600"
        },
        "filter": [">", "count", 1000]
      });
      map.addLayer({
        "id": "p10000",
        "type": "fill",
        "source": "tile",
        "source-layer": "OBSERVATION",
        "paint": {
          "fill-color": "#FF3300"
        },
        "filter": [">", "count", 10000]
      });
      map.addLayer({
        "id": "p100000",
        "type": "fill",
        "source": "tile",
        "source-layer": "OBSERVATION",
        "paint": {
          "fill-color": "#FF0000"
        },
        "filter": [">", "count", 100000]
      });
    }

    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v8',
      center: [0.13, 51.5],
      zoom: 0,
      maxZoom: 20
    });
    map.addControl(new mapboxgl.Navigation());

    map.on('style.load', function () {
      initMap(map, 1900, 2016);
    });


  </script>
</body>
</html>
