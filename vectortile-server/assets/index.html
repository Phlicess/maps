<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
  <meta charset='utf-8'/>
  <title>Maps</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>

  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.20.0/mapbox-gl.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/8.3.0/nouislider.min.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.1.min.js"
      integrity="sha256-gvQgAFzTH6trSrAWoH1iPo9Xc96QxSZ3feW6kem+O00=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
      integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.20.0/mapbox-gl.css' rel='stylesheet'/>
  <link href='nouislider.css' rel='stylesheet'/>
  <link href='style.css' rel='stylesheet'/>

</head>
<body>
<div id='map' class="map"></div>

<div class='features features-about'>
  <h4>GBIF Map Diagnostics</h4>

  <form id="config" class="form-horizontal">

    <div class="form-group col-sm-12">
      <label class="radio-inline">
        <input type="radio" name="_type" id="typeSimple" value="simple" checked> Simple (HBase)
      </label>
      <label class="radio-inline">
        <input type="radio" name="_type" id="typeAdhoc" value="adhoc"> Ad hoc search (SOLR)
      </label>
    </div>

    <hr/>

    <div class="form-group col-sm-12 text-nowrap">
      <label for="mapKey" class="col-sm-3 control-label">Map key</label>
      <div class="col-sm-9">
        <input type="text" class="form-control" id="_mapKey" placeholder="Everything" value="">
      </div>
      <div class="col-md-offset-3 col-sm-3 small">
        <ul class="list-unstyled">
          <li><a href="#" onclick="$('#_mapKey').val(''); $('#_mapKey').change();">Everything</a></li>
          <li><a href="#" onclick="$('#_mapKey').val('taxonKey=1'); $('#_mapKey').change();">Animals</a></li>
          <li><a href="#" onclick="$('#_mapKey').val('taxonKey=6'); $('#_mapKey').change();">Plants</a></li>
        </ul>
      </div>
      <div class="col-sm-3 small">
        <ul class="list-unstyled">
          <li><a href="#" onclick="$('#_mapKey').val('taxonKey=5231190'); $('#_mapKey').change();">House sparrow</a></li>
          <li><a href="#" onclick="$('#_mapKey').val('taxonKey=9703'); $('#_mapKey').change();">Cats</a></li>
          <li><a href="#" onclick="$('#_mapKey').val('country=US'); $('#_mapKey').change();">United States</a></li>
        </ul>
      </div>
      <div class="col-sm-3 small">
        <ul class="list-unstyled">
          <li><a href="#" onclick="$('#_mapKey').val('datasetKey=4fa7b334-ce0d-4e88-aaae-2e0c138d049e'); $('#_mapKey').change();">eBird</a></li>
          <li><a href="#" onclick="$('#_mapKey').val('publishingCountry=DK'); $('#_mapKey').change();">Danish published</a></li>
          <li><a href="#" onclick="$('#_mapKey').val('publishingOrganizationKey=57254bd0-8256-11d8-b7ed-b8a03c50a862'); $('#_mapKey').change();">BGBM</a></li>
        </ul>
      </div>

    </div>
    <hr/>


    <div class="form-group col-sm-12">
      <label class="radio-inline">
        <input type="radio" name="srs" id="srs3857" value="EPSG:3857" checked> Mercator
      </label>
      <label class="radio-inline">
        <input type="radio" name="srs" id="srsWGS84" value="EPSG:4326"> WGS84
      </label>
      <label class="radio-inline">
        <input type="radio" name="srs" id="srs3575" value="EPSG:3575"> Arctic
      </label>
      <label class="radio-inline">
        <input type="radio" name="srs" id="srsTODO" value="EPSG:3575"> Antarctic
      </label>
    </div>

    <hr/>

    <div class="form-group col-sm-7">
      <label class="radio-inline">
        <input type="radio" name="year" id="yearExcluded" value="null" checked> All years
      </label>
      <label class="radio-inline">
        <input type="radio" name="year" id="yearRange" value="1700,2016"><span id="years">1700 - 2016</span></input>
      </label>
    </div>
    <div class="form-group col-sm-5">
      <div id='slider'></div>
    </div>

    <hr/>

    <div class="form-group">
      <div class="col-sm-12">
        Note: If none are selected then no filter is applied, which is equivalent to selecting them all.
        This is in line with all GBIF search APIs.
      </div>

      <div class="col-sm-6">
        <div class="checkbox">
          <label><input type="checkbox" name="basisOfRecord" value="OBSERVATION"> Observation</label>
        </div>
        <div class="checkbox">
          <label><input type="checkbox" name="basisOfRecord" value="HUMAN_OBSERVATION"> Human Observation</label>
        </div>
        <div class="checkbox">
          <label><input type="checkbox" name="basisOfRecord" value="MACHINE_OBSERVATION"> Machine Observation</label>
        </div>
        <div class="checkbox">
          <label><input type="checkbox" name="basisOfRecord" value="MATERIAL_SAMPLE"> Material Sample</label>
        </div>
        <div class="checkbox">
          <label><input type="checkbox" name="basisOfRecord" value="PRESERVED_SPECIMEN"> Preserved Specimen</label>
        </div>
      </div>
      <div class="col-sm-6">
        <div class="checkbox">
          <label><input type="checkbox" name="basisOfRecord" value="FOSSIL_SPECIMEN"> Fossil Specimen</label>
        </div>
        <div class="checkbox">
          <label><input type="checkbox" name="basisOfRecord" value="LIVING_SPECIMEN"> Living Specimen</label>
        </div>
        <div class="checkbox">
          <label><input type="checkbox" name="basisOfRecord" value="LITERATURE"> Literature</label>
        </div>
        <div class="checkbox">
          <label><input type="checkbox" name="basisOfRecord" value="UNKNOWN"> Unknwon</label>
        </div>
      </div>
    </div>

    <hr/>

    <div class="form-group col-sm-12">
      <label for="style" class="col-sm-3 control-label">Style</label>
      <div class="col-sm-9">
        <textarea id="_style" style="font-family: monospace" rows="5" cols="35">{
  "circle-radius": 1.5,
  "circle-color": "#9F9",
  "circle-opacity": 0.5
}</textarea>
      </div>
    </div>

  </form>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZ2JpZiIsImEiOiJjaW0xeXU1c3gwMG04dm1tNXB3cjJ3Zm12In0.8A2pUP_lgL19w4G5L0fDNw';

// gets the query string for the map tiles
function queryParams() {
  // extract the params from the form for the map tiles
  var mapType = null;
  var mapValue = null;
  var config = $('#config').serializeArray().reduce(function(obj, item) {
    if (!obj.params) obj.params=[];

    if (item.name && !item.name.startsWith("_") && item.value && item.value!="null") {
      var param = item.name + "=" + item.value;
      obj.params.push(param);
    }

    if (item.name == "_mapType") mapType = item.value;
    if (item.name == "_mapKey") mapValue = item.value;

    return obj;
  }, {});
  var mapKey = $('#_mapKey').val();
  if (mapKey != "") config.params.push(mapKey);
  return config.params;
}

/**
 * Initialises the map.
 */
function initMap(map) {
  // Remove layers if they exist
  if (map.getSource('base')) map.removeSource('base');
  if (map.getLayer('base')) map.removeLayer('base');
  if (map.getSource('tile')) map.removeSource('tile');
  if (map.getLayer('tile')) map.removeLayer('tile');

  var params = queryParams();
  var queryString = params.join("&");
  console.log(queryString);

  // baseLayer raster
  var baseURL = "http://a.tiles.mapbox.com/v4/gbif.dec5e9ae/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZ2JpZiIsImEiOiJjaWxhZ2oxNWQwMDBxd3FtMjhzNjRuM2lhIn0.g1IE8EfqwzKTkJ4ptv3zNQ";
  if (params.indexOf("srs=EPSG:3575")!=-1) {
    baseURL = "http://b.tiles.arcticconnect.org/osm_3575/{z}/{x}/{y}.png"; // arctic
  } else if (params.indexOf("srs=EPSG:4326")!=-1) {
    // GBIF classic
    baseURL = "https://cartocdn-ashbu.global.ssl.fastly.net/timrobertson100/api/v1/map/f5e2229b2f03a3679e9767ce57aeeccc:1466969734331/0/{z}/{x}/{y}.png?map_key=0384d12bac420293b443cc236120862f3dd75ac1&cache_policy=persist"; // WGS84
    // morten
    baseURL = "http://b.ashbu.cartocdn.com/timrobertson100/api/v1/map/3a222bf37b6c105e0c7c6e3a2a1d6ecc:1467147536105/0/{z}/{x}/{y}.png?cache_policy=persist"
  }
  map.addSource('base', {
    type: 'raster',
    "tiles": [baseURL],
    "tileSize": 256
  });
  map.addLayer({
    "id": "base",
    "type": "raster",
    "source": "base",
    "minzoom": 0,
    "maxzoom": 12
  });

  var backend = $('input[name="_type"]:checked').val();
  var tileLayer = backend == "simple" ? "http://localhost:7001/api/occurrence/density" : "http://localhost:7001/api/solr"

  map.addSource('tile', {
    type: 'vector',
    "tiles": [tileLayer + "/{z}/{x}/{y}.mvt?" + queryString]
  });

  // HBase maps
  if ("simple" == backend) {
    var paint = JSON.parse($("#_style").val());

    map.addLayer({
      "id": "tile",
      "type": "circle",
      "source": "tile",
      "source-layer": "occurrence",
      "paint": paint
    });
  } else {
    // SOLR maps
    map.addLayer({
      "id": "p1",
      "type": "fill",
      "source": "tile",
      "source-layer": "occurrence",
      "paint": {
        "fill-color": "#FFFF00",
        "fill-opacity": 0.8,
        "fill-outline-color": "#999999"
      },
      "filter": [">", "total", 0]
    });

    map.addLayer({
      "id": "p10",
      "type": "fill",
      "source": "tile",
      "source-layer": "occurrence",
      "paint": {
        "fill-color": "#FFCC00",
        "fill-opacity": 0.8,
        "fill-outline-color": "#999999"
      },
      "filter": [">", "total", 10]
    });
    map.addLayer({
      "id": "p100",
      "type": "fill",
      "source": "tile",
      "source-layer": "occurrence",
      "paint": {
        "fill-color": "#FF9900",
        "fill-opacity": 0.8,
        "fill-outline-color": "#999999"
      },
      "filter": [">", "total", 100]
    });
    map.addLayer({
      "id": "p1000",
      "type": "fill",
      "source": "tile",
      "source-layer": "occurrence",
      "paint": {
        "fill-color": "#FF6600",
        "fill-opacity": 0.8,
        "fill-outline-color": "#999999"
      },
      "filter": [">", "total", 1000]
    });
    map.addLayer({
      "id": "p10000",
      "type": "fill",
      "source": "tile",
      "source-layer": "occurrence",
      "paint": {
        "fill-color": "#FF3300",
        "fill-opacity": 0.8,
        "fill-outline-color": "#999999"
      },
      "filter": [">", "total", 10000]
    });
    map.addLayer({
      "id": "p100000",
      "type": "fill",
      "source": "tile",
      "source-layer": "occurrence",
      "paint": {
        "fill-color": "#FF0000",
        "fill-opacity": 0.8,
        "fill-outline-color": "#999999"
      },
      "filter": [">", "total", 100000]
    });

    /*
     map.addLayer({
     "id": "p1-l",
     "type": "line",
     "source": "tile",
     "source-layer": "occurrence",
     "paint": {
     "line-color": "#999999",
     "line-width": 0.25
     }
     });
     */
  }
}

var map = new mapboxgl.Map({
  container: 'map',
  //style: 'mapbox://styles/mapbox/light-v8',
  // default with no style
  style: {
    "version": 8,
    "sources": {},
    "layers": []
  },
  center: [0.13, 51.5],
  zoom: 0,
  maxZoom: 20
});
map.addControl(new mapboxgl.Navigation());

map.on('style.load', function () {
  initMap(map);
});

noUiSlider.create(slider, {
  start: [1700, 2016],
  step: 1,
  connect: true,
  range: {
    'min': 1700,
    'max': 2016
  }
});

// any input change of the form triggers a map reload
$("#config :input").change(function() {
  var backend = $('input[name="_type"]:checked').val();
  if ("adhoc" == backend) {
    // SOLR only supports WGS84
    $('#srsWGS84').prop('checked', true);
  }
  initMap(map);
});

slider.noUiSlider.on('update', function (vals) {
  // only adjust the range the user can see
  document.getElementById("years").innerText = Math.floor(vals[0]) + " - " + Math.floor(vals[1]);
});

slider.noUiSlider.on('change', function (vals) {
  // native JS works, while JQuery seems to have issue
  document.getElementById("yearRange").checked = true;
  document.getElementById("yearExcluded").checked = false;
  document.getElementById("years").innerText = Math.floor(vals[0]) + " - " + Math.floor(vals[1]);
  document.getElementById("yearRange").value = Math.floor(vals[0]) + "," + Math.floor(vals[1]);
  initMap(map); // fire the event to update
});

</script>
</body>
</html>
