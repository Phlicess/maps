package org.gbif.maps.spark

import com.vividsolutions.jts.geom.{Coordinate, GeometryFactory}
import no.ecc.vectortile.VectorTileEncoder
import org.apache.hadoop.hbase.client.HTable
import org.apache.hadoop.hbase.io.ImmutableBytesWritable
import org.apache.hadoop.hbase.mapreduce.HFileOutputFormat
import org.apache.hadoop.hbase.util.Bytes
import org.apache.hadoop.hbase.{HBaseConfiguration, KeyValue}
import org.apache.hadoop.mapreduce.Job
import org.apache.spark.sql.DataFrame
import org.apache.spark.{HashPartitioner, Partitioner, SparkConf, SparkContext}
import org.gbif.maps.common.projection.Mercator
import org.gbif.maps.io.PointFeature
import org.gbif.maps.io.PointFeature.PointFeatures.Feature

import scala.collection.mutable
import scala.collection.mutable.{Map => MMap}

object BackfillTilesPoints10 {

  // Dictionary of map types
  private val MAPS_TYPES = Map("ALL" -> 0, "TAXON" -> 1, "DATASET" -> 2, "PUBLISHER" -> 3, "COUNTRY" -> 4,
    "PUBLISHING_COUNTRY" -> 5)

  // Dictionary mapping the GBIF API BasisOfRecord enumeration to the Protobuf versions
  private val BASIS_OF_RECORD = Map("UNKNOWN" -> PointFeature.PointFeatures.Feature.BasisOfRecord.UNKNOWN,
    "PRESERVED_SPECIMEN" -> PointFeature.PointFeatures.Feature.BasisOfRecord.PRESERVED_SPECIMEN,
    "FOSSIL_SPECIMEN" -> PointFeature.PointFeatures.Feature.BasisOfRecord.FOSSIL_SPECIMEN,
    "LIVING_SPECIMEN" -> PointFeature.PointFeatures.Feature.BasisOfRecord.LIVING_SPECIMEN,
    "OBSERVATION" -> PointFeature.PointFeatures.Feature.BasisOfRecord.OBSERVATION,
    "HUMAN_OBSERVATION" -> PointFeature.PointFeatures.Feature.BasisOfRecord.HUMAN_OBSERVATION,
    "MACHINE_OBSERVATION" -> PointFeature.PointFeatures.Feature.BasisOfRecord.MACHINE_OBSERVATION,
    "MATERIAL_SAMPLE" -> PointFeature.PointFeatures.Feature.BasisOfRecord.MATERIAL_SAMPLE,
    "LITERATURE" -> PointFeature.PointFeatures.Feature.BasisOfRecord.LITERATURE)

  /*
  private val BASIS_OF_RECORD = Map("UNKNOWN" -> PointFeature.PointFeatures.Feature.BasisOfRecord.UNKNOWN,
    "PRESERVED_SPECIMEN" -> PointFeature.PointFeatures.Feature.BasisOfRecord.PRESERVED_SPECIMEN,
    "FOSSIL_SPECIMEN" -> PointFeature.PointFeatures.Feature.BasisOfRecord.FOSSIL_SPECIMEN,
    "LIVING_SPECIMEN" -> PointFeature.PointFeatures.Feature.BasisOfRecord.UNKNOWN,
    "OBSERVATION" -> PointFeature.PointFeatures.Feature.BasisOfRecord.OBSERVATION,
    "HUMAN_OBSERVATION" -> PointFeature.PointFeatures.Feature.BasisOfRecord.OBSERVATION,
    "MACHINE_OBSERVATION" -> PointFeature.PointFeatures.Feature.BasisOfRecord.OBSERVATION,
    "MATERIAL_SAMPLE" -> PointFeature.PointFeatures.Feature.BasisOfRecord.PRESERVED_SPECIMEN,
    "LITERATURE" -> PointFeature.PointFeatures.Feature.BasisOfRecord.UNKNOWN)
  */

  private val POINT_THRESHOLD = 100000;
  private val TILE_SIZE = 512 // good compromise between performance and visuals and fits retina tiles
  private val MERCATOR = new Mercator(TILE_SIZE)
  private val GEOMETRY_FACTORY = new GeometryFactory()
  private val MAX_HFILES_PER_CF_PER_REGION = 32 // defined in HBase's LoadIncrementalHFiles
  private val MAX_ZOOM = 16
  private val MIN_ZOOM = 0

  // Put pixels in the same category together
  class TileGroupPartitioner[K,V](partitions: Int) extends Partitioner {

    def getPartition(key: Any): Int = {
      val k = key.asInstanceOf[(String,String,Feature.BasisOfRecord)]
      // skip ZXY, as that would mean we can't downscale
      var hc = (k._1 + k._3).hashCode()
      if (hc < 0) hc *= -1
      return hc%numPartitions
    }

    override def numPartitions: Int = partitions
  }

  private val TARGET_DIR = "hdfs://nameservice1/tmp/tim_maps"

  /**
    * TODO: fix this
    * Write to the dev cluster for now - always
    */
  private val outputConf = {
    val conf = HBaseConfiguration.create()
    conf.set("hbase.zookeeper.quorum", "c1n2.gbif.org:2181,c1n3.gbif.org:2181,c1n1.gbif.org:2181");
    conf.setInt("hbase.zookeeper.property.clientPort", 2181);
    val job = new Job(conf, "Map tile builder")
    job.setMapOutputKeyClass(classOf[ImmutableBytesWritable]);
    job.setMapOutputValueClass(classOf[KeyValue]);
    val table = new HTable(conf, "tim_test")
    HFileOutputFormat.configureIncrementalLoad(job, table);
    conf
  }


  def main(args: Array[String]) {
    val conf = new SparkConf().setAppName("Map processing")
    //.set("spark.serializer", "org.apache.spark.serializer.KryoSerializer")
    conf.setIfMissing("spark.master", "local[2]") // 2 threads for local dev, ignored in production
    val sc = new SparkContext(conf)
    val sqlContext = new org.apache.spark.sql.SQLContext(sc)
    //val df = sqlContext.read.parquet("/user/hive/warehouse/tim.db/occurrence_map_source")
    //val df = sqlContext.read.parquet("/Users/tim/dev/data/map.parquet")
    val df = sqlContext.read.parquet("/user/hive/warehouse/tim.db/occurrence_map_source_tenth")
    build(sc, df)
  }

  def toMapKey(mapType: Int, key: Any) : String = {
    mapType + ":" + key;
  }

  def toZXY(z: Byte, x: Long, y: Long) : String = {
    z + ":" + x + ":" + y;
  }

  def fromZXY(encoded: String) : (Short,Long,Long) = {
    val zxy = encoded.split(":")
    (zxy(0).toShort, zxy(1).toLong, zxy(2).toLong)
  }

  def encodePixel(x: Short, y: Short): Int = {
    x.toInt << 16 | y
  }

  def decodePixel(p: Int): (Short,Short) = {
    ((p >> 16).asInstanceOf[Short], p.asInstanceOf[Short])
  }

  def encodePixelYear(p: Int, y: Short): Long = {
    p.toLong << 32 | y
  }

  def decodePixelYear(py: Long): (Int,Short) = {
    ((py >> 32).asInstanceOf[Int], py.asInstanceOf[Short])
  }

  // Extracted from the long running process
  def predefViews(): Map[String, Long] = {
    Map(
      "1:2490821" -> 172449,
      "1:7144" -> 128385,
      "1:3073" -> 2494907,
      "5:AT" -> 465390,
      "1:2416" -> 849350,
      "1:6100963" -> 573287,
      "3:6bcc0290-6e76-11db-bcd5-b8a03c50a862" -> 224691,
      "1:4651" -> 263117,
      "1:2398" -> 100745,
      "1:1492" -> 668241,
      "1:2489584" -> 213679,
      "1:4246" -> 205109,
      "1:2607519" -> 127013,
      "1:2481776" -> 149877,
      "1:3172358" -> 157797,
      "1:2498238" -> 156941,
      "1:2482059" -> 224477,
      "1:3029779" -> 103908,
      "1:5230962" -> 230057,
      "1:2489105" -> 1723852,
      "1:6950" -> 214969,
      "1:2498265" -> 160991,
      "1:9329" -> 374556,
      "1:2962244" -> 260029,
      "1:2491468" -> 623623,
      "2:40c0f670-ee87-4576-be9d-2725e0b47035" -> 145166,
      "1:44" -> 28601423,
      "4:ZA" -> 345027,
      "1:2490246" -> 171347,
      "4:AQ" -> 465804,
      "1:2932737" -> 114972,
      "1:4284017" -> 151352,
      "3:07f617d0-c688-11d8-bf62-b8a03c50a862" -> 2630174,
      "1:982" -> 119747,
      "1:5366829" -> 109092,
      "1:9456" -> 154360,
      "1:3925" -> 302811,
      "2:740df67d-5663-41a2-9d12-33ec33876c47" -> 418941,
      "1:2483612" -> 194293,
      "1:2487843" -> 141639,
      "1:2484155" -> 697141,
      "1:2487883" -> 101840,
      "1:2498254" -> 869371,
      "1:2489984" -> 1643066,
      "4:CA" -> 2011131,
      "1:2498334" -> 847260,
      "1:2422" -> 236724,
      "1:3033294" -> 613632,
      "1:2492960" -> 129885,
      "1:2705783" -> 202869,
      "2:84d26682-f762-11e1-a439-00145eb45e9a" -> 190989,
      "2:50c9509d-22c7-4a22-a47d-8c48425ef4a7" -> 689776,
      "1:2482507" -> 1492700,
      "1:2877951" -> 370969,
      "1:2494621" -> 319919,
      "1:7804446" -> 224798,
      "1:2498257" -> 216747,
      "1:2495414" -> 889918,
      "4:EC" -> 148938,
      "1:2487494" -> 208326,
      "1:5232464" -> 123559,
      "1:204" -> 1290892,
      "1:5290090" -> 103135,
      "1:2489158" -> 213239,
      "1:5384616" -> 104361,
      "1:2482473" -> 295986,
      "1:9351" -> 144221,
      "1:1340278" -> 117303,
      "1:2490383" -> 1219023,
      "1:2491650" -> 103952,
      "1:2492196" -> 1095746,
      "1:2480538" -> 103975,
      "1:4689" -> 437965,
      "1:933" -> 639730,
      "3:d3978a37-635a-4ae3-bb85-7b4d41bc0b88" -> 1716446,
      "1:2914401" -> 120624,
      "1:2475646" -> 148809,
      "1:2491534" -> 370828,
      "1:734" -> 207116,
      "1:2704266" -> 245026,
      "1:5257" -> 1102036,
      "1:5290149" -> 201778,
      "1:2489165" -> 312241,
      "1:2481219" -> 195695,
      "1:5310" -> 204967,
      "1:2721893" -> 865733,
      "1:2486655" -> 184158,
      "1:6100825" -> 159689,
      "3:883ee5d0-9177-423d-a636-0284e8a4de46" -> 237908,
      "1:2481854" -> 1135039,
      "1:1231" -> 174721,
      "1:2730118" -> 122215,
      "1:2480295" -> 129204,
      "1:2888645" -> 172713,
      "1:2498408" -> 243555,
      "1:5371818" -> 135172,
      "1:3105" -> 331168,
      "1:3047138" -> 128240,
      "1:2706162" -> 338335,
      "1:5307" -> 188886,
      "1:2478067" -> 1017064,
      "1:2489202" -> 251937,
      "1:3206734" -> 113383,
      "1:2482031" -> 113916,
      "1:2703131" -> 245747,
      "1:2484132" -> 935757,
      "1:3039576" -> 404319,
      "1:2875967" -> 140269,
      "1:8611" -> 125870,
      "2:82e6a41e-f762-11e1-a439-00145eb45e9a" -> 272973,
      "1:9325" -> 255701,
      "1:2492858" -> 217269,
      "1:2481726" -> 181700,
      "1:2474950" -> 322352,
      "4:MA" -> 106820,
      "1:2481890" -> 377048,
      "4:DE" -> 792781,
      "1:2477150" -> 322426,
      "1:2650888" -> 106104,
      "1:2482501" -> 348741,
      "1:2480268" -> 209509,
      "1:7225535" -> 991027,
      "1:7824" -> 102484,
      "1:2114971" -> 168202,
      "1:3242141" -> 1234743,
      "1:2481011" -> 188486,
      "1:5231647" -> 200522,
      "1:3040183" -> 139063,
      "2:6ccb8e14-2396-4953-998a-040bb307a8f0" -> 107418,
      "1:1153" -> 278620,
      "1:6092830" -> 288162,
      "1:2498324" -> 923048,
      "1:5231763" -> 213474,
      "1:2492010" -> 934666,
      "1:2484916" -> 275990,
      "1:2487887" -> 703863,
      "1:2487783" -> 115465,
      "1:2437489" -> 106092,
      "1:6661" -> 121380,
      "1:2487446" -> 242733,
      "1:2490804" -> 112055,
      "1:2704393" -> 100769,
      "5:MX" -> 395011,
      "1:7913436" -> 523133,
      "1:3120641" -> 183253,
      "1:4" -> 525794,
      "1:6390748" -> 242387,
      "1:2473744" -> 237781,
      "1:5429330" -> 182085,
      "1:2493052" -> 319671,
      "5:DK" -> 569584,
      "3:8f152af7-8ecb-42b0-8471-32841a75cb2d" -> 412179,
      "3:e2e717bf-551a-4917-bdc9-4fa0f342c530" -> 12835805,
      "1:2498036" -> 314670,
      "1:3020559" -> 256756,
      "1:6092942" -> 141362,
      "2:358fbd61-739f-4102-afc9-9d468f571e4d" -> 129900,
      "1:2498272" -> 154369,
      "1:327" -> 954082,
      "1:2490810" -> 299387,
      "1:2479601" -> 103478,
      "1:3034560" -> 149278,
      "1:7874143" -> 140482,
      "1:2482462" -> 290201,
      "2:7565c55d-9dc8-442d-95cf-19d5ebb3d2b0" -> 123853,
      "1:367" -> 229075,
      "1:2481022" -> 554657,
      "1:2482049" -> 552659,
      "1:2489214" -> 194748,
      "1:2490934" -> 644164,
      "1:2926553" -> 141112,
      "3:b554c320-0560-11d8-b851-b8a03c50a862" -> 172584,
      "1:9340" -> 740223,
      "1:3189736" -> 239429,
      "1:196" -> 4321908,
      "1:5229734" -> 241156,
      "1:2489438" -> 240495,
      "1:6683" -> 142394,
      "1:5231240" -> 192009,
      "1:2484878" -> 1281985,
      "1:3106738" -> 189358,
      "1:2490241" -> 661090,
      "1:3051" -> 125097,
      "1:7191588" -> 1047606,
      "1:7015" -> 261897,
      "1:2913130" -> 159333,
      "1:2483605" -> 727104,
      "1:6065824" -> 330963,
      "1:839" -> 158712,
      "1:5231640" -> 1082642,
      "1:5231142" -> 339820,
      "1:4902" -> 177455,
      "1:2484385" -> 633035,
      "1:2701261" -> 127851,
      "1:2873815" -> 322138,
      "1:2481679" -> 153766,
      "1:2489127" -> 180468,
      "1:2480577" -> 778542,
      "1:1176" -> 712849,
      "1:2495404" -> 1359043,
      "1:2490737" -> 385066,
      "2:8600a36d-b72d-4612-bfa0-b32aa08e424d" -> 245305,
      "1:1458" -> 137453,
      "1:2482075" -> 359956,
      "1:6979" -> 306825,
      "1:3033363" -> 221717,
      "1:2491170" -> 166988,
      "1:2484277" -> 207385,
      "1:2926556" -> 178314,
      "1:2492516" -> 215960,
      "4:CR" -> 227257,
      "3:396d5f30-dea9-11db-8ab4-b8a03c50a862" -> 327506,
      "3:799acb53-2764-4e89-9792-5fdb6f7d7d29" -> 408439,
      "1:3188736" -> 114258,
      "1:3120946" -> 106399,
      "1:2484444" -> 1117613,
      "1:2491717" -> 138197,
      "1:2492096" -> 242171,
      "1:2480621" -> 355827,
      "1:131" -> 441567,
      "3:ccc2e3ec-98ba-4e74-878d-7dcf0f57baba" -> 190996,
      "1:5298231" -> 131319,
      "1:2705236" -> 199963,
      "1:5959091" -> 224854,
      "1:5602" -> 118143,
      "5:AU" -> 5881558,
      "1:3023221" -> 112521,
      "1:797" -> 1178619,
      "1:1313" -> 235235,
      "1:3036021" -> 136379,
      "1:2890668" -> 117161,
      "1:4342" -> 188440,
      "1:54" -> 4505704,
      "2:82cd8df8-f762-11e1-a439-00145eb45e9a" -> 337163,
      "1:4669" -> 142892,
      "1:2480964" -> 101963,
      "1:2984" -> 872395,
      "3:6c4a0bb0-2a4d-11d8-aa2d-b8a03c50a862" -> 106495,
      "1:5229128" -> 107190,
      "1:2489213" -> 196021,
      "1:5242" -> 3674259,
      "1:2480943" -> 543072,
      "1:9348" -> 863812,
      "4:TW" -> 103098,
      "1:2483597" -> 255736,
      "1:2703179" -> 112945,
      "1:2481954" -> 512306,
      "1:1108" -> 5188601,
      "3:25fe2ec4-4405-4b37-9386-8cc80e337abb" -> 657654,
      "1:3133512" -> 155447,
      "1:2491728" -> 108627,
      "1:2704922" -> 250547,
      "3:75ed4c27-9997-41c4-81a4-675b4282ffad" -> 1100494,
      "1:2491727" -> 108638,
      "1:2876099" -> 188478,
      "1:2988638" -> 406440,
      "1:2877" -> 3206107,
      "1:2481693" -> 186859,
      "1:4334" -> 176359,
      "1:2493863" -> 143788,
      "1:2492943" -> 167230,
      "1:2505" -> 664537,
      "1:7341816" -> 201809,
      "1:5264" -> 1493196,
      "1:3093681" -> 165699,
      "1:2480863" -> 168858,
      "1:2498368" -> 786567,
      "1:2495190" -> 116069,
      "1:7639503" -> 202322,
      "1:2487879" -> 399889,
      "1:2704179" -> 176008,
      "1:2491205" -> 357035,
      "1:2889011" -> 140002,
      "1:2495471" -> 146746,
      "1:4287244" -> 276159,
      "1:2481134" -> 693918,
      "1:2495006" -> 333498,
      "1:6953" -> 135795,
      "1:5290081" -> 108803,
      "1:2495265" -> 126845,
      "1:2494935" -> 480867,
      "1:4119608" -> 157515,
      "1:2490941" -> 491949,
      "1:2703277" -> 196113,
      "1:3108983" -> 109871,
      "1:9293" -> 115074,
      "1:5357013" -> 137342,
      "1:4409023" -> 277576,
      "1:2484391" -> 595443,
      "1:3085897" -> 287435,
      "1:3117424" -> 146231,
      "1:5229158" -> 174891,
      "3:b4640710-8e03-11d8-b956-b8a03c50a862" -> 102641,
      "1:2888951" -> 239515,
      "1:2430" -> 494597,
      "1:2477865" -> 579480,
      "1:2482048" -> 110690,
      "1:2498261" -> 277212,
      "1:2480637" -> 140260,
      "1:2705064" -> 107916,
      "1:5284" -> 261234,
      "1:2489445" -> 108476,
      "1:2487413" -> 159496,
      "1:2487406" -> 784503,
      "1:2480487" -> 393817,
      "1:3241514" -> 421156,
      "1:2984391" -> 322636,
      "1:1447" -> 988210,
      "1:5384604" -> 180767,
      "1:2489222" -> 1141846,
      "1:5231459" -> 437502,
      "1:3024294" -> 157699,
      "1:7219248" -> 508930,
      "1:2482414" -> 227606,
      "1:2497286" -> 125577,
      "1:2480444" -> 572318,
      "1:5229134" -> 115528,
      "1:2480817" -> 271482,
      "1:2489169" -> 215355,
      "1:3169330" -> 191666,
      "1:1370" -> 2313544,
      "1:8214667" -> 523861,
      "1:809" -> 226503,
      "1:3148688" -> 202791,
      "1:6715" -> 164563,
      "1:6093209" -> 147939,
      "1:7192755" -> 403805,
      "1:9333" -> 3475243,
      "1:7982160" -> 416189,
      "1:1144" -> 166698,
      "1:7707728" -> 11943164,
      "1:9359" -> 147839,
      "1:2494543" -> 291286,
      "1:5393839" -> 209292,
      "2:4fa7b334-ce0d-4e88-aaae-2e0c138d049e" -> 12815299,
      "1:2476673" -> 209610,
      "1:2978223" -> 347073,
      "1:1414" -> 1451406,
      "3:0e0fc0f0-828e-11d8-b7ed-b8a03c50a862" -> 1393403,
      "1:2495370" -> 141228,
      "1:1112" -> 125082,
      "1:8300875" -> 242553,
      "1:50" -> 181148,
      "1:2481206" -> 121215,
      "1:8747" -> 100902,
      "1:2495093" -> 116499,
      "1:43" -> 167665,
      "1:1335" -> 268467,
      "1:3134951" -> 131884,
      "1:2480278" -> 128821,
      "1:1003" -> 124942,
      "1:6631" -> 351557,
      "1:2483527" -> 372887,
      "1:2494988" -> 156821,
      "1:8577" -> 112942,
      "1:98" -> 402042,
      "1:3191366" -> 124542,
      "1:1353" -> 1273378,
      "1:2490748" -> 284565,
      "1:2888810" -> 100231,
      "5:CA" -> 569618,
      "1:5371742" -> 161472,
      "1:6391648" -> 127648,
      "1:5229675" -> 141472,
      "2:d6cc311c-c5ab-4f23-9a20-10514f9eb9c4" -> 134970,
      "1:4673" -> 136344,
      "1:2509" -> 211032,
      "1:2492192" -> 155594,
      "1:1493" -> 1587254,
      "1:2498349" -> 223014,
      "1:2481784" -> 157759,
      "1:8195144" -> 131325,
      "1:7211" -> 612660,
      "1:2481149" -> 102579,
      "4:IE" -> 504618,
      "1:9339" -> 267538,
      "1:9322" -> 1160832,
      "4:AT" -> 395414,
      "1:2480498" -> 175749,
      "1:6093694" -> 148729,
      "1:2494155" -> 208821,
      "1:2478523" -> 196300,
      "1:7190978" -> 261226,
      "1:7710229" -> 108784,
      "1:8736" -> 177452,
      "1:7341834" -> 434005,
      "1:2889949" -> 295705,
      "1:2474940" -> 503862,
      "1:2701072" -> 537902,
      "1:5256" -> 270935,
      "2:13b70480-bd69-11dd-b15f-b8a03c50a862" -> 115608,
      "1:2975287" -> 137869,
      "1:5275132" -> 107274,
      "1:2478596" -> 300175,
      "1:2481659" -> 147110,
      "1:2487456" -> 133668,
      "1:9313" -> 511746,
      "1:2490486" -> 327011,
      "1:7467942" -> 420863,
      "1:5273" -> 216555,
      "1:2494422" -> 496878,
      "1:950" -> 164817,
      "1:6625" -> 192478,
      "1:3133468" -> 124552,
      "1:2809736" -> 110843,
      "5:BR" -> 363720,
      "1:3113" -> 106875,
      "1:2478130" -> 130430,
      "3:28eb1a3f-1c15-4a95-931a-4af90ecb574d" -> 689762,
      "1:414" -> 2601972,
      "1:2498122" -> 524383,
      "1:8468" -> 127716,
      "1:2493118" -> 104523,
      "5:FR" -> 509646,
      "1:3143303" -> 128380,
      "1:2495189" -> 116057,
      "3:95f1c5d0-8996-11d9-a962-b8a03c50a862" -> 337717,
      "1:2494642" -> 378753,
      "1:2492606" -> 170531,
      "1:3093702" -> 160605,
      "1:2493112" -> 289987,
      "1:617" -> 541727,
      "3:8483a1f0-1032-11db-ae00-b8a03c50a862" -> 102255,
      "1:7341805" -> 805427,
      "1:2482357" -> 142059,
      "5:BE" -> 2440015,
      "1:2492116" -> 212188,
      "1:2498387" -> 319561,
      "1:2478133" -> 102382,
      "1:2882316" -> 101855,
      "1:2393" -> 110485,
      "1:5229247" -> 138339,
      "1:2480529" -> 316267,
      "1:2493801" -> 605827,
      "1:2510" -> 251559,
      "1:2498077" -> 202381,
      "1:5372952" -> 104474,
      "1:2489181" -> 538170,
      "1:789" -> 258600,
      "1:7780" -> 168762,
      "1:2926678" -> 152623,
      "3:c4254a00-cb2b-11d8-bf68-b8a03c50a862" -> 225633,
      "1:2705971" -> 203483,
      "1:2481819" -> 236447,
      "1:7760886" -> 156939,
      "1:2927077" -> 105699,
      "1:2878688" -> 208236,
      "1:2492109" -> 582667,
      "1:2492462" -> 418423,
      "1:6920" -> 186077,
      "1:551" -> 644732,
      "1:2477899" -> 499468,
      "1:2490327" -> 307721,
      "3:84a50274-bfbe-49aa-af23-29c3703126f9" -> 177343,
      "3:fb702600-a84e-11de-978d-b8a03c50a862" -> 555701,
      "1:2481187" -> 416952,
      "1:7533935" -> 168379,
      "1:2987833" -> 103184,
      "1:1172" -> 206295,
      "1:2495455" -> 447671,
      "1:2475462" -> 545442,
      "1:2473551" -> 228688,
      "4:NZ" -> 390548,
      "1:9319" -> 635255,
      "1:2482515" -> 192160,
      "1:2490774" -> 186448,
      "1:3127469" -> 178972,
      "1:643" -> 116131,
      "1:2888944" -> 138358,
      "1:6176" -> 2686814,
      "1:7224021" -> 262135,
      "1:2474376" -> 717151,
      "1:2489637" -> 632311,
      "1:2481959" -> 157837,
      "3:47e00926-5a2f-44e8-8509-139a689c8b4d" -> 1801890,
      "1:5331649" -> 134948,
      "1:2488483" -> 392489,
      "1:5365576" -> 141131,
      "1:733" -> 180204,
      "1:5400948" -> 131521,
      "1:2484183" -> 215610,
      "1:2480830" -> 225116,
      "1:2493047" -> 572540,
      "1:6725" -> 111836,
      "1:2487453" -> 100736,
      "2:4bf1cca8-832c-4891-9e17-7e7a65b7cc81" -> 990758,
      "3:c3ad790a-d426-4ac1-8e32-da61f81f0117" -> 149578,
      "1:2480763" -> 120584,
      "1:3118160" -> 239051,
      "1:2477950" -> 147878,
      "1:2927228" -> 209893,
      "1:5959190" -> 111768,
      "2:7a1e4274-f762-11e1-a439-00145eb45e9a" -> 408438,
      "5:FI" -> 587971,
      "1:8742" -> 123669,
      "1:2481745" -> 195724,
      "1:2984510" -> 100484,
      "1:359" -> 1814882,
      "1:392" -> 872118,
      "1:5845582" -> 418992,
      "1:2496287" -> 122695,
      "1:399" -> 1085295,
      "1:2495346" -> 1591825,
      "1:2875979" -> 137176,
      "1:2492009" -> 951103,
      "1:2481342" -> 107209,
      "1:2481710" -> 101086,
      "1:3002148" -> 222958,
      "1:2498305" -> 224874,
      "1:5231677" -> 747769,
      "1:2498264" -> 253305,
      "1:2889077" -> 180449,
      "1:7683" -> 435290,
      "1:2491651" -> 103813,
      "1:3241982" -> 114163,
      "1:190" -> 136360,
      "1:2481721" -> 162646,
      "1:691" -> 1710146,
      "1:2480798" -> 114100,
      "1:2972934" -> 146421,
      "1:6639" -> 392060,
      "1:8807" -> 114039,
      "1:2481714" -> 200349,
      "1:3241751" -> 371689,
      "1:1450" -> 1130417,
      "1:2477872" -> 200127,
      "1:3034740" -> 115360,
      "1:2962960" -> 147336,
      "1:5229754" -> 112667,
      "1:2478487" -> 259274,
      "1:7341600" -> 112753,
      "1:2495852" -> 149555,
      "1:3053118" -> 116048,
      "1:2473548" -> 229769,
      "1:5334277" -> 118199,
      "1:2498247" -> 102566,
      "1:9308" -> 352159,
      "1:2481209" -> 120563,
      "1:4848452" -> 577402,
      "1:4650" -> 183750,
      "1:5353" -> 675560,
      "1:9350" -> 1851520,
      "1:5230791" -> 980215,
      "1:2486569" -> 203890,
      "3:2d6e0e40-2aee-11d8-aa2d-b8a03c50a862" -> 289759,
      "1:5289877" -> 149204,
      "1:5386" -> 2246302,
      "4:CO" -> 212382,
      "1:3148475" -> 178716,
      "1:2490310" -> 119038,
      "1:2888741" -> 132289,
      "1:3083823" -> 163007,
      "1:549" -> 188521,
      "1:4688" -> 420973,
      "1:2987999" -> 187563,
      "1:2487363" -> 147423,
      "1:121" -> 172400,
      "1:2703777" -> 115336,
      "1:5341299" -> 125156,
      "1:2492596" -> 200509,
      "1:2484879" -> 348132,
      "1:2705495" -> 150335,
      "1:2481236" -> 195689,
      "1:2492870" -> 171171,
      "2:67c54f85-7910-4cbf-8de4-6f0b136a0e34" -> 210061,
      "1:2888721" -> 168270,
      "4:BR" -> 525244,
      "1:2481875" -> 595921,
      "1:2882481" -> 166103,
      "1:2705484" -> 122059,
      "1:5229166" -> 126189,
      "1:640" -> 473601,
      "1:5341184" -> 106695,
      "1:6721" -> 235434,
      "1:2481047" -> 196536,
      "1:8328" -> 136841,
      "1:2487782" -> 1794065,
      "1:225" -> 637201,
      "1:621" -> 198040,
      "3:3693ff90-4c16-11d8-b290-b8a03c50a862" -> 412297,
      "1:6093857" -> 152856,
      "1:9321" -> 1385830,
      "1:2490781" -> 247435,
      "1:5372605" -> 128277,
      "1:2480217" -> 175348,
      "1:5015" -> 1317082,
      "1:2474794" -> 159240,
      "1:2888728" -> 141669,
      "2:7bd65a7a-f762-11e1-a439-00145eb45e9a" -> 635227,
      "1:5231190" -> 1286499,
      "1:1459" -> 423774,
      "1:6664" -> 514257,
      "1:2491871" -> 185079,
      "4:CL" -> 118143,
      "1:3148323" -> 188267,
      "1:5429347" -> 230536,
      "1:5789298" -> 142482,
      "1:1169" -> 1259841,
      "1:2492235" -> 219087,
      "1:2498073" -> 212372,
      "1:2891642" -> 162962,
      "1:4287243" -> 323393,
      "1:724" -> 3531832,
      "1:3047430" -> 132944,
      "1:2702260" -> 133771,
      "1:2888811" -> 100044,
      "1:5358748" -> 270860,
      "1:3045752" -> 156633,
      "1:2479597" -> 153505,
      "1:5229155" -> 146931,
      "1:5371741" -> 169634,
      "1:2490494" -> 196135,
      "1:2482079" -> 138480,
      "1:5285637" -> 131494,
      "1:3189767" -> 173081,
      "1:946" -> 599059,
      "1:2926960" -> 115540,
      "1:2368" -> 183713,
      "1:421" -> 111907,
      "3:1cd669d0-80ea-11de-a9d0-f1765f95f18b" -> 2294993,
      "1:2482612" -> 122269,
      "5:CO" -> 144787,
      "1:6635" -> 137134,
      "1:7192754" -> 512369,
      "1:2704173" -> 580673,
      "1:2407" -> 252343,
      "3:c5f7ef70-e233-11d9-a4d6-b8a03c50a862" -> 274231,
      "1:2491557" -> 242158,
      "1:2390" -> 265543,
      "1:2481174" -> 1446808,
      "1:2480255" -> 132237,
      "1:5229335" -> 111291,
      "1:2481203" -> 101785,
      "1:3085458" -> 103607,
      "1:2494329" -> 147231,
      "3:90fd6680-349f-11d8-aa2d-b8a03c50a862" -> 635188,
      "1:2480935" -> 884897,
      "1:2477741" -> 485638,
      "1:2482468" -> 3027864,
      "1:7341606" -> 184838,
      "1:9342" -> 1153718,
      "1:2490714" -> 2691071,
      "1:2474604" -> 111408,
      "1:949" -> 127141,
      "1:203" -> 301133,
      "1:2382" -> 102131,
      "2:aab0cf80-0c64-11dd-84d1-b8a03c50a862" -> 237904,
      "1:3045622" -> 264955,
      "1:2878" -> 351200,
      "4:FR" -> 721357,
      "1:2487601" -> 440819,
      "1:3170861" -> 112036,
      "1:2481808" -> 411833,
      "1:2420" -> 882693,
      "1:3721" -> 114587,
      "1:2347608" -> 171219,
      "1:6710" -> 320888,
      "1:5405032" -> 102287,
      "1:8059811" -> 132315,
      "1:5481" -> 214243,
      "2:6ac3f774-d9fb-4796-b3e9-92bf6c81c084" -> 436088,
      "1:2927173" -> 163515,
      "1:2480872" -> 554715,
      "4:PE" -> 126191,
      "1:3118349" -> 224219,
      "1:2480542" -> 1010188,
      "1:2489985" -> 255545,
      "1:2672916" -> 101458,
      "1:3113414" -> 126364,
      "1:5936" -> 107068,
      "1:2494919" -> 778550,
      "1:2498" -> 608052,
      "1:2668958" -> 136231,
      "1:7" -> 100477,
      "1:2480348" -> 374538,
      "1:2402" -> 169154,
      "1:7708" -> 1332017,
      "3:2cd829bb-b713-433d-99cf-64bef11e5b3e" -> 126393,
      "1:2481962" -> 271387,
      "1:2724925" -> 119338,
      "3:e5585950-488e-11db-a1c2-b8a03c50a862" -> 123727,
      "1:5231141" -> 339980,
      "1:2484892" -> 722873,
      "1:2498084" -> 122245,
      "1:2483315" -> 543194,
      "1:6694" -> 107147,
      "1:811" -> 464095,
      "1:2494310" -> 147325,
      "1:2490266" -> 260652,
      "2:d9717973-840e-46e1-af55-17f5086b888a" -> 114251,
      "1:2684241" -> 229044,
      "1:3034830" -> 128063,
      "4:AU" -> 5704197,
      "1:941" -> 656217,
      "1:590" -> 249805,
      "1:2480277" -> 1018413,
      "1:2482054" -> 208993,
      "1:2480791" -> 127022,
      "1:2487923" -> 629804,
      "1:2494441" -> 197995,
      "1:2679851" -> 136591,
      "1:2495485" -> 118396,
      "1:2481927" -> 1066010,
      "1:4352369" -> 239268,
      "1:3176176" -> 404243,
      "1:2490263" -> 128201,
      "1:2481700" -> 135754,
      "1:2493213" -> 103526,
      "1:1354" -> 792954,
      "1:2489613" -> 241710,
      "1:2503" -> 190017,
      "1:2475648" -> 130138,
      "1:2481781" -> 422174,
      "1:7678064" -> 121369,
      "1:952" -> 345449,
      "1:229" -> 686182,
      "1:2498246" -> 114843,
      "1:785" -> 118916,
      "1:2490700" -> 278231,
      "1:8215487" -> 131046,
      "1:7745240" -> 129677,
      "1:5268" -> 1180509,
      "1:715" -> 588522,
      "1:8351737" -> 125299,
      "1:7342009" -> 215172,
      "1:2925812" -> 106836,
      "1:3065" -> 2363889,
      "1:2487825" -> 114888,
      "1:5225" -> 236026,
      "1:5375388" -> 131876,
      "1:2480925" -> 379264,
      "1:5231694" -> 267799,
      "1:7689" -> 624376,
      "1:2498190" -> 1482293,
      "1:7901064" -> 283916,
      "1:2888995" -> 140353,
      "1:2478259" -> 924193,
      "1:4691" -> 449533,
      "1:2498112" -> 281826,
      "1:2482424" -> 603768,
      "1:2481774" -> 168651,
      "1:6101141" -> 212342,
      "1:5708" -> 128787,
      "1:2986" -> 5177541,
      "5:IE" -> 468618,
      "1:5235" -> 4386286,
      "1:495" -> 108333,
      "1:2493843" -> 192234,
      "1:5263" -> 2403196,
      "1:1448" -> 1374284,
      "1:408" -> 2252487,
      "1:5231198" -> 284711,
      "3:526a57bd-769c-4cc9-94ae-1eb9bdfa5d6c" -> 389730,
      "1:2495347" -> 1496498,
      "1:2481691" -> 102323,
      "1:2481172" -> 418179,
      "1:2481792" -> 250543,
      "1:2479670" -> 101960,
      "1:3161935" -> 177455,
      "1:2428" -> 128407,
      "1:7192775" -> 1390930,
      "1:2481720" -> 231277,
      "1:5739317" -> 158661,
      "4:PT" -> 129813,
      "1:3039547" -> 106604,
      "1:2498375" -> 359875,
      "1:2481713" -> 144545,
      "1:2494577" -> 1644629,
      "1:3192923" -> 125800,
      "1:2497486" -> 269519,
      "1:5288" -> 422621,
      "1:7071443" -> 167714,
      "1:2497" -> 1113047,
      "1:2492576" -> 170104,
      "1:7191147" -> 4031402,
      "1:2481146" -> 129165,
      "1:6173226" -> 957843,
      "2:aa6c5ee6-d4d7-4a65-a04f-379cffbf4842" -> 177342,
      "1:2489129" -> 157539,
      "1:3064" -> 496043,
      "1:624" -> 360683,
      "1:2489200" -> 265476,
      "1:2481748" -> 143345,
      "1:2473738" -> 237800,
      "1:5388602" -> 113883,
      "1:2477781" -> 963605,
      "1:9338" -> 1047508,
      "1:9289" -> 152025,
      "1:1050" -> 142584,
      "1:587" -> 516444,
      "1:2482033" -> 106810,
      "2:be2af664-2990-4153-99b5-d92bbd8cdb0e" -> 412160,
      "1:2716791" -> 156230,
      "1:7682" -> 173992,
      "1:2487871" -> 171117,
      "1:2480819" -> 244289,
      "1:5279" -> 858459,
      "1:9327" -> 2883323,
      "1:2687921" -> 147938,
      "1:2480210" -> 1746507,
      "1:2492521" -> 156199,
      "2:7e380070-f762-11e1-a439-00145eb45e9a" -> 107013,
      "1:7788295" -> 208877,
      "1:2490871" -> 170950,
      "1:2867589" -> 105311,
      "1:5361816" -> 301946,
      "1:8061978" -> 216410,
      "1:7991371" -> 108684,
      "1:2481669" -> 127184,
      "1:2874237" -> 312908,
      "1:2703302" -> 167534,
      "3:b8323864-602a-4a7d-9127-bb903054e97d" -> 4696134,
      "1:3172047" -> 393316,
      "1:6" -> 12957618,
      "1:1341" -> 113528,
      "2:4ce8e3f9-2546-4af1-b28d-e2eadf05dfd4" -> 1801909,
      "1:2482791" -> 108262,
      "1:3188731" -> 134176,
      "1:1333" -> 309380,
      "1:4408414" -> 443121,
      "1:9309" -> 667187,
      "1:2480829" -> 225276,
      "1:2498151" -> 368987,
      "2:38b4c89f-584c-41bb-bd8f-cd1def33e92f" -> 4696067,
      "1:2713455" -> 110303,
      "1:404" -> 100523,
      "1:9368" -> 137216,
      "1:1496" -> 142945,
      "1:6697" -> 165170,
      "1:9701" -> 118359,
      "1:9074" -> 195530,
      "1:3241790" -> 278986,
      "1:2484596" -> 221303,
      "1:3729" -> 133993,
      "1:3034742" -> 100482,
      "1:2701311" -> 238944,
      "2:492d63a8-4978-4bc7-acd8-7d0e3ac0e744" -> 141571,
      "1:2704178" -> 261809,
      "1:6100954" -> 296987,
      "1:246" -> 332643,
      "1:6735" -> 104463,
      "1:2491210" -> 273334,
      "1:2482352" -> 155845,
      "1:7191407" -> 1364232,
      "1:4900406" -> 238257,
      "1:2684359" -> 113825,
      "1:2477968" -> 383245,
      "1:2704504" -> 152512,
      "1:732" -> 614602,
      "1:2474377" -> 262839,
      "1:2882482" -> 166082,
      "1:2490295" -> 622203,
      "1:5334400" -> 131656,
      "1:9316" -> 4962701,
      "5:NL" -> 1025517,
      "1:3811517" -> 125142,
      "1:2498089" -> 386421,
      "2:271c444f-f8d8-4986-b748-e7367755c0c1" -> 158598,
      "1:2478106" -> 741154,
      "1:2481942" -> 327452,
      "1:2490326" -> 445061,
      "5:SE" -> 5359674,
      "1:6657" -> 347036,
      "2:0645ccdb-e001-4ab0-9729-51f1755e007e" -> 657628,
      "1:6688" -> 132989,
      "1:2498009" -> 125402,
      "1:9320" -> 123621,
      "1:5356701" -> 109131,
      "1:2475472" -> 520809,
      "1:6651" -> 381614,
      "1:2495696" -> 394377,
      "1:358" -> 668669,
      "1:2410" -> 920470,
      "1:35" -> 1010165,
      "5:JP" -> 118760,
      "1:8801" -> 322839,
      "1:8751" -> 171096,
      "1:2496214" -> 212279,
      "1:2487140" -> 126974,
      "1:2498263" -> 136557,
      "1:2494150" -> 288402,
      "1:8322495" -> 197458,
      "1:2706434" -> 489521,
      "1:2498343" -> 391399,
      "1:2490696" -> 279840,
      "1:3189452" -> 227936,
      "1:9331" -> 964093,
      "1:9284" -> 195161,
      "1:6093856" -> 105691,
      "2:d415c253-4d61-4459-9d25-4015b9084fb0" -> 183396,
      "1:2367" -> 142088,
      "3:ff90b050-c256-11db-b71b-b8a03c50a862" -> 314127,
      "1:3013395" -> 189326,
      "1:9115" -> 136953,
      "1:180" -> 623294,
      "1:2492956" -> 248405,
      "1:2487430" -> 367766,
      "1:206" -> 115470,
      "5:EE" -> 161548,
      "1:5248" -> 2249261,
      "1:2486619" -> 165744,
      "1:5473" -> 249855,
      "1:5400982" -> 127886,
      "1:52" -> 851677,
      "1:2480326" -> 358841,
      "1:1055" -> 174610,
      "1:2705282" -> 116585,
      "1:2486761" -> 134870,
      "1:2705308" -> 252829,
      "1:2489633" -> 228162,
      "4:NL" -> 754531,
      "1:2487613" -> 244107,
      "1:1337" -> 104018,
      "1:5231918" -> 201304,
      "4:MX" -> 879725,
      "1:2875008" -> 258784,
      "3:2498d55c-dcd2-4caf-abb7-14f2ffe05c37" -> 419811,
      "1:7539507" -> 129513,
      "1:2933951" -> 106628,
      "1:934" -> 197782,
      "1:3026341" -> 141568,
      "1:2484605" -> 215486,
      "1:5231438" -> 322700,
      "1:6093759" -> 104810,
      "1:2482593" -> 1137037,
      "1:3105646" -> 151904,
      "1:2487581" -> 366697,
      "1:3051713" -> 106171,
      "1:2491872" -> 184987,
      "1:5959160" -> 170937,
      "1:3115745" -> 101342,
      "1:2876213" -> 156211,
      "1:5712" -> 333496,
      "5:ZZ" -> 1611175,
      "1:5356854" -> 109336,
      "1:2479307" -> 158225,
      "1:400" -> 245057,
      "1:9379" -> 116032,
      "1:5229387" -> 102334,
      "1:3720" -> 139644,
      "1:5262" -> 172680,
      "1:2479598" -> 153520,
      "1:194" -> 474866,
      "2:e45c7d91-81c6-4455-86e3-2965a5739b1f" -> 150186,
      "1:3012146" -> 218892,
      "1:2495000" -> 192228,
      "1:5251" -> 218390,
      "1:2490799" -> 503908,
      "1:1" -> 33651228,
      "1:5369652" -> 111908,
      "2:dce8feb0-6c89-11de-8225-b8a03c50a862" -> 210284,
      "1:6685" -> 436004,
      "1:3172323" -> 173652,
      "1:690" -> 1492120,
      "1:2974751" -> 255777,
      "2:5df38344-b821-49c2-8174-cf0f29f4df0d" -> 382200,
      "1:2489160" -> 204200,
      "1:2687937" -> 108131,
      "1:5361975" -> 131242,
      "1:381" -> 238979,
      "1:2482513" -> 126911,
      "1:8424370" -> 113776,
      "1:5282" -> 2373203,
      "1:2488484" -> 132830,
      "1:6101019" -> 365921,
      "1:2705307" -> 253376,
      "1:2490298" -> 430718,
      "1:5014" -> 757526,
      "1:2706000" -> 158910,
      "1:2650583" -> 189594,
      "1:2487144" -> 100145,
      "1:3189172" -> 127372,
      "1:2480612" -> 233693,
      "1:2480481" -> 504878,
      "2:83a1a8c2-f762-11e1-a439-00145eb45e9a" -> 696691,
      "1:2482598" -> 201091,
      "1:723" -> 1200750,
      "1:5230862" -> 104035,
      "1:6746" -> 115676,
      "2:2a513d16-f4ce-4252-974f-2486ce70b788" -> 244567,
      "1:4671" -> 186088,
      "1:2706490" -> 202430,
      "1:2481338" -> 127875,
      "3:24f26321-3960-4a16-a8e9-b3dfb401a9a4" -> 253710,
      "1:5789066" -> 371534,
      "1:2491719" -> 138102,
      "1:9290" -> 146997,
      "1:2481709" -> 929232,
      "1:461" -> 154516,
      "1:2484142" -> 186806,
      "1:2489178" -> 655187,
      "1:8144" -> 169613,
      "1:422" -> 1873543,
      "1:2373" -> 326509,
      "1:2706217" -> 236221,
      "1:5289756" -> 168372,
      "1:2484182" -> 283956,
      "5:GB" -> 3260498,
      "1:7340825" -> 105010,
      "1:2495086" -> 147005,
      "1:4852454" -> 297252,
      "1:7357320" -> 213527,
      "5:NZ" -> 186449,
      "1:8175054" -> 213491,
      "1:2480962" -> 117202,
      "1:2389" -> 316491,
      "1:2493797" -> 606195,
      "1:6640" -> 102745,
      "1:2480366" -> 110524,
      "2:83986ffa-f762-11e1-a439-00145eb45e9a" -> 215082,
      "1:2481759" -> 222842,
      "1:2888942" -> 533327,
      "1:2480922" -> 1570036,
      "3:19456090-b49a-11d8-abeb-b8a03c50a862" -> 106989,
      "1:2484609" -> 533333,
      "1:2756560" -> 189433,
      "1:2482359" -> 162245,
      "1:5229688" -> 300936,
      "1:2481797" -> 478540,
      "1:2985" -> 316908,
      "1:2498111" -> 227519,
      "4:EE" -> 152395,
      "1:2484340" -> 262544,
      "1:2235048" -> 280258,
      "1:7698" -> 229358,
      "1:2474393" -> 430268,
      "1:5365261" -> 307288,
      "1:2480897" -> 109955,
      "1:2700604" -> 247942,
      "1:2492941" -> 497202,
      "1:2704505" -> 149864,
      "1:2493861" -> 168245,
      "1:2498386" -> 327224,
      "2:857aa892-f762-11e1-a439-00145eb45e9a" -> 224774,
      "1:2973363" -> 451476,
      "1:2993" -> 707121,
      "1:2476843" -> 146913,
      "1:5275012" -> 121472,
      "1:2518" -> 900366,
      "1:2482524" -> 111645,
      "1:2476674" -> 200065,
      "1:2748017" -> 150509,
      "2:15f819bd-6612-4447-854b-14d12ee1022d" -> 264057,
      "1:2482481" -> 183552,
      "1:2494421" -> 606843,
      "3:0870a77b-587c-4369-a8ed-bc3d347b8e1c" -> 127082,
      "1:3036074" -> 127475,
      "1:2483607" -> 120322,
      "1:2487866" -> 202013,
      "1:2492093" -> 751727,
      "1:620" -> 142892,
      "3:66522820-055c-11d8-b84e-b8a03c50a862" -> 266247,
      "2:82cb293c-f762-11e1-a439-00145eb45e9a" -> 254263,
      "1:3189834" -> 189483,
      "1:3117399" -> 146628,
      "1:7947184" -> 286014,
      "1:7226638" -> 103312,
      "1:7668163" -> 147813,
      "1:2417" -> 156027,
      "3:bc092ff0-02e4-11dc-991f-b8a03c50a862" -> 382906,
      "1:7383532" -> 148805,
      "1:8208358" -> 238193,
      "1:5367246" -> 140538,
      "1:5228199" -> 132127,
      "3:fb10a11f-4417-41c8-be6a-13a5c8535122" -> 214910,
      "1:5231140" -> 538102,
      "1:2488517" -> 161869,
      "1:2913027" -> 527476,
      "1:1456" -> 194007,
      "1:5230754" -> 139265,
      "1:2482077" -> 359889,
      "1:2925668" -> 249259,
      "1:2487516" -> 122333,
      "1:2706164" -> 299725,
      "1:5291" -> 1986399,
      "1:2487844" -> 441143,
      "1:5231138" -> 105026,
      "1:2888580" -> 109872,
      "1:5709" -> 230598,
      "1:2481215" -> 192402,
      "1:2704913" -> 413588,
      "1:2651523" -> 100936,
      "1:6623" -> 167933,
      "1:2703642" -> 238356,
      "1:1445" -> 744152,
      "1:4635" -> 228273,
      "1:9285" -> 1982541,
      "1:7874883" -> 119828,
      "1:953" -> 125412,
      "1:5215" -> 741600,
      "1:6634" -> 101662,
      "1:2482766" -> 406730,
      "2:f1929b90-79f5-47aa-b983-51f108eb491f" -> 375063,
      "1:2498016" -> 464424,
      "1:2496285" -> 158335,
      "1:2490872" -> 170814,
      "1:2498299" -> 235387,
      "1:2651126" -> 242069,
      "1:2498326" -> 614618,
      "1:2481608" -> 112775,
      "1:8615" -> 235122,
      "1:2913548" -> 167496,
      "1:2406" -> 206129,
      "1:1304" -> 154480,
      "1:5240" -> 1364402,
      "1:6674" -> 512795,
      "3:09b17aee-d3fb-48ca-a30b-303d671a8155" -> 210061,
      "1:6172" -> 158574,
      "1:2403" -> 117115,
      "1:2480873" -> 265681,
      "4:AR" -> 111747,
      "4:SE" -> 5218113,
      "1:2928997" -> 304897,
      "1:5229205" -> 125810,
      "1:7609" -> 113797,
      "1:2482040" -> 174848,
      "1:2481660" -> 123158,
      "1:7336" -> 256277,
      "1:3085667" -> 337799,
      "1:5231132" -> 437736,
      "1:9355" -> 1755758,
      "4:FI" -> 601310,
      "1:6065844" -> 189567,
      "1:2489340" -> 145687,
      "1:2494529" -> 291976,
      "1:5232446" -> 102431,
      "3:06fcbbf0-0562-11d8-b851-b8a03c50a862" -> 117970,
      "1:7192402" -> 7543964,
      "1:8369" -> 107614,
      "1:1351" -> 1058024,
      "1:2483729" -> 406558,
      "1:2480327" -> 190990,
      "1:2494708" -> 178188,
      "1:1340" -> 113279,
      "1:5391599" -> 115632,
      "1:5231722" -> 207189,
      "1:5341478" -> 115113,
      "1:2480517" -> 1568671,
      "4:" -> 341999,
      "1:2498154" -> 264423,
      "1:2495657" -> 541838,
      "1:7190953" -> 2630740,
      "1:5228824" -> 364058,
      "1:6701" -> 283849,
      "1:2702102" -> 105691,
      "1:2487924" -> 582657,
      "1:245" -> 170739,
      "1:9352" -> 197698,
      "1:2476402" -> 312829,
      "1:3172085" -> 120752,
      "1:2676502" -> 128081,
      "1:2486621" -> 117202,
      "1:3189695" -> 404522,
      "1:5231630" -> 314192,
      "1:2414" -> 232952,
      "1:2497496" -> 137660,
      "1:2480332" -> 150143,
      "1:7924597" -> 142498,
      "1:2867567" -> 159873,
      "1:2498165" -> 116799,
      "1:2700828" -> 102751,
      "1:5275011" -> 140726,
      "1:2475391" -> 122985,
      "3:d2b97690-bfd6-11de-b279-d52977ace833" -> 468618,
      "3:4c415e40-1e21-11de-9e40-a0d6ecebb8bf" -> 331426,
      "1:5229490" -> 423484,
      "3:8b734449-479a-4924-8f7a-9a2a64112f8f" -> 126409,
      "1:5229230" -> 101484,
      "1:2479869" -> 129609,
      "1:2492542" -> 100138,
      "4:US" -> 14293869,
      "1:1470" -> 912119,
      "1:2481941" -> 327556,
      "1:2498407" -> 244589,
      "1:5" -> 1613910,
      "1:5414296" -> 132555,
      "1:2498006" -> 177008,
      "1:2484452" -> 1112712,
      "1:2489612" -> 241791,
      "1:7771801" -> 163867,
      "4:ES" -> 1058655,
      "1:2481227" -> 447114,
      "1:3122939" -> 110374,
      "1:2492852" -> 129698,
      "1:2482492" -> 890952,
      "4:NO" -> 2776012,
      "1:8621" -> 111912,
      "1:2481800" -> 207531,
      "1:34" -> 895769,
      "1:2484282" -> 467683,
      "1:3286" -> 104911,
      "1:6093345" -> 183270,
      "1:3063749" -> 224086,
      "1:588" -> 177704,
      "1:8323485" -> 904249,
      "1:5230789" -> 149578,
      "4:PG" -> 102120,
      "1:7415507" -> 107349,
      "1:2482394" -> 247909,
      "1:8800" -> 217604,
      "1:4848913" -> 110909,
      "1:679" -> 244585,
      "1:2489590" -> 213460,
      "1:2986095" -> 117020,
      "1:2882780" -> 146412,
      "1:7226464" -> 608073,
      "3:ff418020-1d67-11d9-8435-b8a03c50a862" -> 137853,
      "1:2474953" -> 161988,
      "1:5231635" -> 242005,
      "1:2703162" -> 149162,
      "2:b124e1e0-4755-430f-9eab-894f25a9b59c" -> 1716288,
      "1:2706241" -> 212053,
      "1:5228514" -> 252446,
      "1:3189067" -> 370065,
      "1:1369" -> 3266661,
      "1:8069969" -> 129350,
      "1:2474758" -> 290345,
      "1:2492460" -> 418659,
      "5:DE" -> 997305,
      "1:9294" -> 105812,
      "1:7960979" -> 291681,
      "1:2481930" -> 1062145,
      "1:5227" -> 440944,
      "4:JP" -> 166806,
      "1:6364031" -> 133564,
      "1:954" -> 332197,
      "1:8095051" -> 581878,
      "1:1499" -> 413629,
      "3:bb646dff-a905-4403-a49b-6d378c2cf0d9" -> 436082,
      "1:6689" -> 106423,
      "1:2927208" -> 122068,
      "1:407" -> 162559,
      "1:2483336" -> 576556,
      "1:3085387" -> 122890,
      "1:2489670" -> 535935,
      "1:2705475" -> 239105,
      "1:3033282" -> 103354,
      "1:2484254" -> 228154,
      "1:42" -> 220676,
      "1:7531611" -> 161165,
      "1:5265" -> 197666,
      "1:3012167" -> 172710,
      "1:3792" -> 157985,
      "1:1452" -> 198269,
      "1:6720" -> 890579,
      "1:2706435" -> 273560,
      "1:2965200" -> 138546,
      "1:8104397" -> 180345,
      "1:2497035" -> 111942,
      "1:9276" -> 115885,
      "1:8798" -> 920072,
      "1:2483240" -> 180546,
      "5:NO" -> 2748709,
      "1:3242344" -> 577734,
      "1:2492321" -> 1486384,
      "2:086a644d-6cbe-43b7-b7c7-d33d36028d7f" -> 274166,
      "2:95db4db8-f762-11e1-a439-00145eb45e9a" -> 117263,
      "1:2989" -> 138461,
      "1:7453566" -> 166058,
      "1:3240723" -> 153011,
      "1:2771359" -> 116761,
      "1:2498056" -> 2397547,
      "1:2484589" -> 858451,
      "1:9315" -> 546181,
      "1:2494936" -> 480721,
      "1:623" -> 136345,
      "1:2483606" -> 454506,
      "1:2478232" -> 954448,
      "1:2073" -> 155452,
      "1:2928386" -> 130297,
      "1:3189870" -> 116836,
      "1:2487875" -> 400942,
      "1:7592255" -> 135788,
      "1:2228010" -> 132940,
      "1:2927122" -> 124904,
      "1:9" -> 353520,
      "1:3685" -> 2273305,
      "1:2491079" -> 109596,
      "1:2480996" -> 1289838,
      "1:2482051" -> 132008,
      "1:2480725" -> 442945,
      "1:5243" -> 108365,
      "1:5331916" -> 131077,
      "1:2480446" -> 452130,
      "4:MG" -> 138912,
      "1:5232437" -> 1332043,
      "1:6652" -> 288808,
      "1:220" -> 9791114,
      "3:14c5f0f0-1dab-11d9-8435-b8a03c50a862" -> 337187,
      "1:5289" -> 780529,
      "1:3016227" -> 111932,
      "1:2498256" -> 104888,
      "1:5229227" -> 242816,
      "1:2484597" -> 473691,
      "1:2494997" -> 193933,
      "1:5228676" -> 244428,
      "1:2673041" -> 135435,
      "1:7340584" -> 141366,
      "1:8169649" -> 224570,
      "1:2480537" -> 172877,
      "1:3169386" -> 101776,
      "1:2491204" -> 656147,
      "1:2486528" -> 115914,
      "1:2498255" -> 103816,
      "1:5228080" -> 114204,
      "1:2481817" -> 156069,
      "1:729" -> 15459925,
      "1:6684" -> 168640,
      "1:2490719" -> 577725,
      "5:ES" -> 920543,
      "1:7017" -> 478848,
      "1:2481728" -> 158624,
      "1:7228684" -> 963440,
      "1:2705975" -> 195377,
      "1:3112554" -> 364424,
      "1:2493841" -> 192378,
      "1:2498347" -> 355047,
      "1:2494701" -> 281034,
      "1:9312" -> 512264,
      "1:868" -> 263494,
      "1:2481139" -> 1595742,
      "1:2888431" -> 100068,
      "1:2482592" -> 1335900,
      "1:3083650" -> 165226,
      "1:2484604" -> 741630,
      "5:US" -> 18218468,
      "1:2480524" -> 129798,
      "1:2882813" -> 169895,
      "4:GB" -> 3020741,
      "1:2494987" -> 157064,
      "1:2481126" -> 3987800,
      "1:6092631" -> 172994,
      "1:8077224" -> 277574,
      "1:126" -> 319332,
      "1:5233" -> 3408483,
      "1:2489099" -> 1755413,
      "1:2490936" -> 105542,
      "1:2228004" -> 139095,
      "1:5229493" -> 290038,
      "1:3014454" -> 162028,
      "1:2480856" -> 187902,
      "1:2484591" -> 280163,
      "1:5510" -> 109399,
      "1:2498017" -> 125374,
      "1:731" -> 149442,
      "1:7224005" -> 128323,
      "1:5341297" -> 135783,
      "1:5229487" -> 163186,
      "1:186" -> 855179,
      "1:3033339" -> 307718,
      "1:4668" -> 112360,
      "1:2704858" -> 142536,
      "1:7813543" -> 328354,
      "1:2480894" -> 139881,
      "1:2987968" -> 211027,
      "1:2480320" -> 681574,
      "1:2488485" -> 114050,
      "1:2490615" -> 230408,
      "1:2481196" -> 122276,
      "3:f314b0b0-e3dc-11d9-8d81-b8a03c50a862" -> 886910,
      "1:3241900" -> 226579,
      "1:5238" -> 115940,
      "1:2494943" -> 357052,
      "1:2498273" -> 151239,
      "2:4bfac3ea-8763-4f4b-a71a-76a6f5f243d3" -> 102647,
      "1:1457" -> 691082,
      "1:4481" -> 109313,
      "1:4844128" -> 1063609,
      "1:2498352" -> 214325,
      //"1:212" -> 24641452,
      "1:2492942" -> 152748,
      "1:5229388" -> 120220,
      "4:DK" -> 625447,
      "1:2493091" -> 278220,
      "2:4fa894f4-b6c6-4ec0-b816-9bb03b3ca106" -> 555657,
      "1:2490384" -> 1207685,
      "1:2926557" -> 177703,
      "1:7972010" -> 144243,
      "2:853006c0-f762-11e1-a439-00145eb45e9a" -> 209976,
      "1:2474205" -> 163774,
      "1:2492191" -> 1223729,
      "1:2486654" -> 184222,
      "1:2498159" -> 128073,
      "1:8305" -> 223017,
      "1:637" -> 256471,
      "1:7821030" -> 122631,
      "1:2498370" -> 526088,
      "1:7390893" -> 164920,
      "1:2374" -> 107332,
      "1:2487886" -> 829589,
      "1:9358" -> 806901,
      "2:857bce66-f762-11e1-a439-00145eb45e9a" -> 289799,
      "1:2477732" -> 1325039,
      "1:1145" -> 216840,
      "1:6065818" -> 140352,
      "1:5285" -> 562955,
      "4:BE" -> 1820612,
      "1:7717" -> 480440,
      "1:2480771" -> 128396,
      "1:2487867" -> 171718,
      "1:9608" -> 4003035,
      "1:2478605" -> 220852,
      "1:2494622" -> 234504,
      "1:2494686" -> 294182,
      "1:2490765" -> 1483113,
      "1:2484248" -> 435207,
      "1:2874875" -> 105057,
      "1:2481205" -> 101614,
      "1:3120060" -> 199795,
      "1:2480242" -> 390776,
      "1:4652" -> 137174,
      "1:8137614" -> 187240,
      "1:3034824" -> 149719,
      "1:4676" -> 359198,
      "1:2498329" -> 403008,
      "2:83e20573-f7dd-4852-9159-21566e1e691e" -> 2065007,
      "3:ae447c50-b8a8-11d8-92a4-b8a03c50a862" -> 183394,
      "1:2487603" -> 164465,
      "1:7341822" -> 185164,
      "1:2687913" -> 330536,
      "1:2497541" -> 108160,
      "1:2481958" -> 117161,
      "1:1048" -> 428640,
      "1:1446" -> 3409829,
      "1:2490487" -> 127660,
      "1:3189486" -> 105918,
      "1:2972897" -> 156896,
      "1:2489396" -> 105790,
      "1:2498132" -> 1609159,
      "1:2480260" -> 323402,
      "1:3112" -> 920195,
      "1:2487596" -> 335382,
      "1:5959118" -> 163106,
      "1:2495070" -> 216548,
      "1:137" -> 272148,
      "1:6910" -> 102255,
      "1:256" -> 133822,
      "1:2481042" -> 311186,
      "1:2488947" -> 103879,
      "1:5371685" -> 101684,
      "1:2497027" -> 129580,
      "1:412" -> 1254662,
      "1:9347" -> 115458,
      "1:2486879" -> 237788,
      "1:5229935" -> 115331,
      "1:5283" -> 1281988,
      "1:8097467" -> 495745,
      "1:8383671" -> 106408,
      "5:ZA" -> 301700,
      "1:2492483" -> 221152,
      "3:770c30d2-c2a8-4bb2-8056-6167297cddae" -> 210283,
      "1:2487805" -> 836261,
      "1:2490313" -> 170385,
      "1:2396" -> 167194,
      "3:4fd82480-ea1c-11da-8db4-b8a03c50a862" -> 108366,
      "1:2493899" -> 899426,
      "1:2481798" -> 270976,
      "1:5290" -> 3494646,
      "1:2487881" -> 102079,
      "1:2498237" -> 334709,
      "1:2481739" -> 645936,
      "1:216" -> 3503213,
      "1:4922264" -> 122711,
      "1:95" -> 836483,
      "1:2480726" -> 431722
    )
  }

  def viewsToPyramid(df : DataFrame): Map[String, Long] = {
    var counts = df.flatMap(row => {
      val res = mutable.ArrayBuffer[((String, Double, Double, Feature.BasisOfRecord, Short),Int)]()
      val lat = row.getDouble(row.fieldIndex("decimallatitude"))
      if (lat >= -85 && lat <= 85) {
        val lng = row.getDouble(row.fieldIndex("decimallongitude"))
        val bor = BASIS_OF_RECORD(row.getString(row.fieldIndex("basisofrecord")))
        val year = if (row.isNullAt(row.fieldIndex("year"))) null.asInstanceOf[Short]
        else row.getInt((row.fieldIndex("year"))).asInstanceOf[Short]

        // extract all the keys from the data that can result in a view
        val datasetKey = row.getString(row.fieldIndex("datasetkey"))
        res += (((toMapKey(MAPS_TYPES("DATASET"), datasetKey), lat, lng, bor, year),1))

        val publisherKey = row.getString(row.fieldIndex("publishingorgkey"))
        res += (((toMapKey(MAPS_TYPES("PUBLISHER"), publisherKey), lat, lng, bor, year),1))

        if (!row.isNullAt(row.fieldIndex("countrycode"))) {
          val countryCode = row.getString(row.fieldIndex("countrycode"))
          res += (((toMapKey(MAPS_TYPES("COUNTRY"), countryCode), lat, lng, bor, year),1))
        }

        if (!row.isNullAt(row.fieldIndex("publishingcountry"))) {
          val publishingCountry = row.getString(row.fieldIndex("publishingcountry"))
          res += (((toMapKey(MAPS_TYPES("PUBLISHING_COUNTRY"), publishingCountry), lat, lng, bor, year),1))
        }

        var taxonIDs = Set[Int]()
        //if (!row.isNullAt(row.fieldIndex("kingdomkey"))) taxonIDs+=row.getInt(row.fieldIndex("kingdomkey"))
        if (!row.isNullAt(row.fieldIndex("phylumkey"))) taxonIDs+=row.getInt(row.fieldIndex("phylumkey"))
        if (!row.isNullAt(row.fieldIndex("classkey"))) taxonIDs+=row.getInt(row.fieldIndex("classkey"))
        if (!row.isNullAt(row.fieldIndex("orderkey"))) taxonIDs+=row.getInt(row.fieldIndex("orderkey"))
        if (!row.isNullAt(row.fieldIndex("familykey"))) taxonIDs+=row.getInt(row.fieldIndex("familykey"))
        if (!row.isNullAt(row.fieldIndex("genuskey"))) taxonIDs+=row.getInt(row.fieldIndex("genuskey"))
        if (!row.isNullAt(row.fieldIndex("specieskey"))) taxonIDs+=row.getInt(row.fieldIndex("specieskey"))
        if (!row.isNullAt(row.fieldIndex("taxonkey"))) taxonIDs+=row.getInt(row.fieldIndex("taxonkey"))

        taxonIDs.foreach(id => {
          res += (((toMapKey(MAPS_TYPES("TAXON"), id), lat, lng, bor, year),1))
        })
      }
      res
    }).reduceByKey(_+_).map(r => {(r._1._1, r._2)}).countByKey().filter(r=>{r._2>=POINT_THRESHOLD}).toMap

    // Hint: useful runtime info in production use
    counts.foreach(c => println(c._1 + " is suitable for the tile pyramiding with " + c._2 + " records"))
    counts
  }

  def build(sc :SparkContext, df : DataFrame): Unit = {
    //val mapViewsToTile = sc.broadcast(viewsToPyramid(df).keySet)
    val mapViewsToTile = sc.broadcast(predefViews.keySet)

    var pointSource = df.flatMap(row => {
      val res = mutable.ArrayBuffer[((String, Double, Double, Feature.BasisOfRecord, Short), Long)]()
      val lat = row.getDouble(row.fieldIndex("decimallatitude"))
      if (lat >= -85 && lat <= 85) {
        val lng = row.getDouble(row.fieldIndex("decimallongitude"))
        val bor = BASIS_OF_RECORD(row.getString(row.fieldIndex("basisofrecord")))
        val year = if (row.isNullAt(row.fieldIndex("year"))) null.asInstanceOf[Short]
        else row.getInt((row.fieldIndex("year"))).asInstanceOf[Short]

        // Add the record to the dataset view if required
        val datasetKey = toMapKey(MAPS_TYPES("DATASET"), row.getString(row.fieldIndex("datasetkey")))
        if (!mapViewsToTile.value.contains(datasetKey)) {
          res += (((datasetKey, lat, lng, bor, year),1))
        }

        // Add the record to the publisher view if required
        val publisherKey = toMapKey(MAPS_TYPES("PUBLISHER"), row.getString(row.fieldIndex("publishingorgkey")))
        if (!mapViewsToTile.value.contains(publisherKey)) {
          res += (((publisherKey, lat, lng, bor, year),1))
        }

        // Add the record to the country view if required
        if (!row.isNullAt(row.fieldIndex("countrycode"))) {
          val countryCode = toMapKey(MAPS_TYPES("COUNTRY"), row.getString(row.fieldIndex("countrycode")))
          if (!mapViewsToTile.value.contains(countryCode)) {
            res += (((countryCode, lat, lng, bor, year),1))
          }
        }

        // Add the record to the publihsing country view if required
        if (!row.isNullAt(row.fieldIndex("publishingcountry"))) {
          val countryCode = toMapKey(MAPS_TYPES("PUBLISHING_COUNTRY"), row.getString(row.fieldIndex("publishingcountry")))
          if (!mapViewsToTile.value.contains(countryCode)) {
            res += (((countryCode, lat, lng, bor, year),1))
          }
        }

        // Add the the record to the distinct taxa views, if required
        var taxonIDs = Set[Int]()
        if (!row.isNullAt(row.fieldIndex("kingdomkey"))) taxonIDs+=row.getInt(row.fieldIndex("kingdomkey"))
        if (!row.isNullAt(row.fieldIndex("phylumkey"))) taxonIDs+=row.getInt(row.fieldIndex("phylumkey"))
        if (!row.isNullAt(row.fieldIndex("classkey"))) taxonIDs+=row.getInt(row.fieldIndex("classkey"))
        if (!row.isNullAt(row.fieldIndex("orderkey"))) taxonIDs+=row.getInt(row.fieldIndex("orderkey"))
        if (!row.isNullAt(row.fieldIndex("familykey"))) taxonIDs+=row.getInt(row.fieldIndex("familykey"))
        if (!row.isNullAt(row.fieldIndex("genuskey"))) taxonIDs+=row.getInt(row.fieldIndex("genuskey"))
        if (!row.isNullAt(row.fieldIndex("specieskey"))) taxonIDs+=row.getInt(row.fieldIndex("specieskey"))
        if (!row.isNullAt(row.fieldIndex("taxonkey"))) taxonIDs+=row.getInt(row.fieldIndex("taxonkey"))
        taxonIDs.foreach(id => {
          val taxonKey = toMapKey(MAPS_TYPES("TAXON"), id)
          if (!mapViewsToTile.value.contains(taxonKey)) {
            res += (((taxonKey, lat, lng, bor, year),1))
          }
        })
      }
      res
    }).reduceByKey(_+_, 200).map(r => {
      // type: lat,lng,bor,year,count
      (r._1._1,(r._1._2,r._1._3,r._1._4,r._1._5,r._2.asInstanceOf[Int]))
    })

    val res = pointSource.groupByKey().mapValues(r => {
      val builder = PointFeature.PointFeatures.newBuilder();
      r.foreach(f => {
        val fb = PointFeature.PointFeatures.Feature.newBuilder();
        fb.setLatitude(f._1)
        fb.setLongitude(f._2)
        fb.setBasisOfRecord(f._3)
        fb.setYear(f._4)
        fb.setCount(f._5)
        builder.addFeatures(fb)
      })
      builder.build().toByteArray
    }).repartitionAndSortWithinPartitions(new HashPartitioner(1000)).map(r => {
      val k = new ImmutableBytesWritable(Bytes.toBytes(r._1))
      val row = new KeyValue(Bytes.toBytes(r._1), // key
        Bytes.toBytes("wgs84"), // column family
        Bytes.toBytes("features"), // cell
        r._2 // cell value
      )
      (k, row)
    })


    res.saveAsNewAPIHadoopFile(TARGET_DIR + "/points-wgs84", classOf[ImmutableBytesWritable], classOf[KeyValue], classOf[HFileOutputFormat], outputConf)

  }
}

